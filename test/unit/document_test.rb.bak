require 'test_helper'

class DocumentTest < ActiveSupport::TestCase
    
  should "have Hash type metadata" do
    assert(Document.new(:metadata=>{}).m.class == Hash)
    assert(Document.new(:metadata=>{:a=>1}).m[:a] == 1)
    #assert(Document.new(:metadata=>"").m.class == Hash)
    assert_raise(ActiveRecord::SerializationTypeMismatch){Document.new(:metadata=>"").m}
  end

  context "A document with mark-up" do
    setup do
      @doc = documents("cal2")
      @doc.add_tags("taga,tagb", "u")
    end

    should "get tag and metadata from markup" do
      @doc.process_markup
      #debugger
      assert(@doc.concept_titles.include?('tag1'), "tag1 exists")
      assert(@doc.concept_titles.include?('tag2'), "tag2 exists")
      assert_equal(4, @doc.concept_titles.size, "existing tags are not preserved #{@doc.concept_titles.inspect}")
      assert_equal("meta_value", @doc.m[:meta_key1])
      assert_equal(-2, @doc.m[:meta_key3])
      assert_equal(-1, @doc.m[:score])
    end
  end

  context "A document with multi-tag mark-up" do
    setup do
      @doc = documents("cal0")
    end
    
    should "get tags and metadata from markup" do
      @doc.process_markup
      assert(1, (@doc.concept_titles - ['tag1','tag2','tag3','tag4']).size)
      assert(@doc.concept_titles.include?("non@alphabet-tag"))
      assert_equal("meta_value", @doc.m[:meta_key3])
      assert_equal(-2, @doc.m[:meta_key4])
    end
  end
  
  context "A document with tagging rules" do
    setup do
      @doc = documents("cal1")
      @rules = []
      @rules << rules("T1") << rules("T2") << rules("T2_2")
      assert_equal(3, @rules.size)
    end
    
    should "return text given target" do
      assert_equal(@doc.title, @doc.text_in(:title))
      assert_equal(@doc.m[:meta_key1], @doc.text_in(:meta_key1))
      assert_equal(@doc.m[:type], @doc.text_in(:type))
      assert_raise(ArgumentError){@doc.text_in("title")}
    end
    
    should "be validated according to given condition(s)" do
      assert @doc.validate_by_condition({}) 
      cond = {:title=>"/bla/",:type=>":hourly", :hour_do=>"1..4", :grade=>"['A0','A-']"}
      assert @doc.validate_by_condition(cond) 
      
      assert !@doc.validate_by_condition(cond.merge(:grade=>"['A+','B0']"))
      assert !@doc.validate_by_condition(cond.merge(:title=>"/blo/"))
      assert @doc.validate_by_condition(cond.merge(:title=>/bla/))
    end

    should "get tags from rule" do
      cond = {}
      @doc.add_tags("tag0", "u")
      assert @doc.validate_by_condition(cond.merge(:tag=>"/tag0/")), "tag0 exists!"
      assert !@doc.validate_by_condition(cond.merge(:tag=>"/tag1/")), "tag1 doesn't exists!"
      @doc.process_rules(@rules)
      assert_equal(5, @doc.concepts.size, "concepts were created")
      assert_equal(5, @doc.occurrences.size, "occurrences were created")
      #debugger
      assert @doc.validate_by_condition(cond.merge(:tag=>"/tag1/")), "tag1 was created!"
      assert @doc.validate_by_condition(cond.merge(:tag=>"/tag4/")), "tag4 was created!"
      assert @doc.validate_by_condition(:tag=>/tag3/), "tag3 was created"
      assert_equal(5, @doc.concept_titles.size)
    end
  end
end
